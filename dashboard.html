<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TextBuddy Dashboard</title>
</head>
<body>
  <h1>Welcome to your dashboard!</h1>
  <p id="user-email"></p>

<h2>Create a Companion</h2>
<form id="companion-form">
  <input type="text" id="companion-name" placeholder="Companion name" required />
  <br />
  <textarea id="companion-personality" placeholder="Describe their personality" required></textarea>
  <br />
  <button type="submit">Create Companion</button>
</form>
<p id="status-message"></p>
  
  <button id="logout-btn">Log out</button>
<script type="module">
  import { supabase } from './supabaseClient.js';

  // Get user info
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    window.location.href = '/index.html'; // redirect to login if not authed
  } else {
    document.getElementById('user-email').textContent = `Logged in as ${user.email}`;

    // OPTIONAL: Add user to "users" table
    const { error } = await supabase.from('users').insert([
      { id: user.id, email: user.email }
    ]).select();

    if (error && !error.message.includes('duplicate key')) {
      console.error('❌ Error inserting user into users table:', error.message);
    }
  }

  // Companion creation logic
  document.getElementById('companion-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('companion-name').value;
    const personality = document.getElementById('companion-personality').value;

    const { data: userData, error: userErr } = await supabase.auth.getUser();
    const user_id = userData.user?.id;

    if (!user_id) {
      alert('Not logged in');
      return;
    }

    const { error: insertError } = await supabase.from('companions').insert([{
      user_id,
      name,
      personality,
      twilio_number: '+12267714663'
    }]);

    const msg = document.getElementById('status-message');
    if (insertError) {
      console.error(insertError);
      msg.textContent = '❌ Failed to create companion.';
    } else {
      msg.textContent = '✅ Companion created!';
      e.target.reset();
    }
  });

  // Logout button
  document.getElementById('logout-btn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/index.html';
  });
</script>
</body>
</html>
